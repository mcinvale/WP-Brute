#!/bin/sh
# find all WP login attempts
grep -h 'POST /wp-login.php' /var/log/httpd/domains/*.log | awk '{print $1}' | sort -n | uniq -cd > /tmp/wp-brute.txt

# get all of our DROP rules
iprules=`iptables --list INPUT -n | grep DROP`

while read LOG
do

	attempts=`echo $LOG | awk '{print $1}'`
	ip=`echo $LOG | awk '{print $2}'`

	if [ "$attempts" -ge "50" ]; then
		# make sure itâ€™s not banned already
		maybeban=`echo $iprules | grep $ip`
		
		if [[ -z "$maybeban" ]]; then
			logger "wp-brute.sh is banning" $ip "for" $attempts "login attempts."
			iptables -I INPUT -s $ip -j DROP
		fi
	fi
	
done < /tmp/wp-brute.txt